<template>
  <div class='ygdy-box'>
    <checkData ref="checkBDC" :showHT='showHT'
    @setDisalbed='setDisalbed' :baseInfo='baseInfo'></checkData>
    <infoTable ref="tableInfo" :isVisable='show' :info='info' :isEdit='isEdit'></infoTable>
    <dyxx ref="dyxx" :isVisible='show' @isSubmit = "getSubmit"></dyxx>
  </div>
</template>

<script>
import checkData from '@/components/realReg/checkData';
import infoTable from '@/components/realReg/eszydy/listInfo.vue';
import dyxx from '@/components/realReg/dyxx';
import { mapMutations, mapState } from 'vuex';
import { saveESZYDY } from '@/apis/nres/ygdy';
import { formatDate } from '@/libs/date';

export default {
  data() {
    return {
      show: false,
      info: '',
      showHT: false,
      typeName: '流程实例',
      parentPnode: 'eszydy',
      isRule: false, // 判断抵押信息组件是否通过验证
      baseInfo: {
        zsm: '原权证号',
        labelmc: '原权证号',
        ywlx: 'cqzh',
        labelqlr: '原权利人名称',
      },
      isEdit: false,
      messageSave: {
        lcmc: '二手转移(含抵押)登记',
        djxl: '二手转移(含抵押)登记',
        djdl: '910',
        ajzt: '0',
        sqr: '',
        xgzh: '',
        htbh: '',
        sqbh: 'W',
        ywlxbm: 'eszydy',
        qlrxx: {
          ywr: [],
          qlr: [],
          dyqr: [],
          zwr: [],
        },
        tsgl: [],
        dyxx: [],
      },
    };
  },
  components: {
    checkData,
    infoTable,
    dyxx,
  },
  methods: {
    ...mapMutations('eszydy', { setMessJson: 'SET_MESSAGEJSON' }),
    ...mapMutations('eszydy', { setNodeName: 'SET_NODENAME' }),
    setDisalbed(bdisabled) {
      this.$parent.isDisabled = bdisabled;
      this.$emit('btnDisabled', bdisabled);
    },
    // 获取子组件状态
    getSubmit(type) {
      this.isRule = Boolean(type[1]);
    },
    submitT() {
      this.$refs.dyxx.submitForm();
    },
    getOptions(messageSave) {
      return Object.assign(messageSave, {
        sqrq: formatDate(new Date(), 1),
        gyfs: this.$refs.tableInfo.gyfs,
        sqbh: this.$refs.checkBDC.checkform.sqbh,
        sqr: sessionStorage.userId,
        htbh: this.$refs.checkBDC.checkform.htbh,
        qlrmc: this.$refs.checkBDC.checkform.qlrmc,
        qlrxx: {
          qlr: this.$refs.tableInfo.qlrDataFormat,
          ywr: this.$refs.tableInfo.ywrDataFormat,
          dyqr: this.$refs.tableInfo.dyqrDataFormat,
          dyr: this.$refs.tableInfo.qlrDataFormat,
          zwr: this.$refs.tableInfo.zwrDataFormat,
        },
        dyxx: { ...this.$refs.dyxx.getDyxx() },
        tsgl: this.$refs.tableInfo.getTSXX(),
        fwzl: this.$refs.checkBDC.fwzl,
      });
    },
    setOptions(messageSave) {
      this.isEdit = true;
      this.$refs.checkBDC.checkform.sqbh = messageSave.sqbh;
      this.$refs.checkBDC.checkform.htbh = messageSave.htbh;
      this.$refs.checkBDC.checkform.qlrmc = messageSave.qlrmc;// messageSave.qlrxx.dyr[0].name;
      this.$refs.checkBDC.handleCheck();
      this.$refs.tableInfo.qlrData = messageSave.qlrxx.qlr;
      // console.log(this.$refs.tableInfo.qlrData);
      this.$refs.tableInfo.ywrData = messageSave.qlrxx.ywr;
      this.$refs.tableInfo.dyqrData = messageSave.qlrxx.dyqr;
      // this.$refs.tableInfo.dyrData = messageSave.qlrxx.dyr;
      this.$refs.tableInfo.zwrData = messageSave.qlrxx.zwr;
      this.$refs.dyxx.dyxxForm = { ...messageSave.dyxx };
    },
    handlerStorage() {
      // 第一步时验证dyxx子表单提交
      this.submitT();
      if (!this.isRule) {
        this.$message({
          type: 'warning',
          message: '信息输入不完整',
        });
        return;
      }
      const options = this.getOptions(this.messageSave);
      this.setMessJson(options);
      // console.log(JSON.stringify(options));
      saveESZYDY(options).then((response) => {
        if (response.code === 0) {
          this.$message({
            type: 'success',
            message: '保存成功',
          });
        } else {
          this.$message.error('保存失败！请稍后重试或联系管理员');
          throw new Error(response.msg);
        }
      }).catch((err) => {
        this.$message.error('保存失败！请稍后重试或联系管理员');
        throw new Error(err.message);
      });
    },

    handlerUp() {
      this.submitT();
      if (!this.isRule) {
        this.$message({
          type: 'warning',
          message: '信息输入不完整',
        });
        return;
      }
      const options = this.getOptions(this.messageSave);
      this.setMessJson(options);
      this.handlerStorage();
      this.$emit('funcNext', 1);
    },
  },
  created() {

  },
  mounted() {
    this.$refs.checkBDC.parentPnode = this.parentPnode;
    this.$nextTick(() => {
      const varSqbh = this.$route.params.sqbh;
      if (varSqbh === null || varSqbh === undefined) {
        // console.log('1');
      } else {
        const flowdata = this.flowdatas.filter(p => p.sqbh === varSqbh);
        this.messageSave = { ...flowdata[0].flowdata };
        this.setOptions(this.messageSave);
      }
    });
  },
  computed: {
    ...mapState('queryData', { flowdatas: state => state.FlOWDATA }),
  },
};

</script>
