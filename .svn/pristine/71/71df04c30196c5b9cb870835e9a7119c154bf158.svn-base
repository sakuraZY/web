
<template>
<div>
  <el-table :data="familyData" class="tb-edit"  style="width: 100%;"
    highlight-current-row
        tooltip-effect="dark"
        border
        stripe
        width="80%"
        :cell-style="{padding:'3px'}"
        :header-cell-style="tableHeaderColor"
        height="200px">
    <el-table-column label="序号" align='center' width="58">
        <template scope="scope">
            <span>{{scope.$index + 1}}</span>
        </template>
    </el-table-column>
    <el-table-column  label="姓名" align='center' width="120">
        <template scope="scope">
            <el-input size="small" v-model="scope.row.name"
            placeholder="请输入内容" v-if="scope.row.isShow">
            </el-input>
            <span v-else>{{scope.row.name}}</span>
        </template>
    </el-table-column>
    <el-table-column prop="zjlbzw" label="证件类型" align='center' width="150">
        <template scope="scope">
            <el-select v-model="scope.row.zjlb" placeholder="请选择"
            v-if="scope.row.isShow" @change="selectChange(scope.$index, scope.row)">
                <el-option
                v-for="item in IdArray"
                :key="item.value"
                :label="item.label"
                :value="item.value">
                </el-option>
            </el-select>
            <span v-else>{{scope.row.zjlbzw}}</span>
        </template>
    </el-table-column>
    <el-table-column prop="zjhm" label="证件号码" align='center' width="150">
        <template scope="scope">
            <el-input size="small" v-model="scope.row.zjhm"
            placeholder="请输入内容"
            v-if="scope.row.isShow">
            </el-input>
            <span v-else>{{scope.row.zjhm}}</span>
        </template>
    </el-table-column>
    <el-table-column prop="gx" label="关系">
        <template scope="scope">
            <el-input size="small" v-model="scope.row.gx"
            placeholder="请输入内容"
            v-if="scope.row.isShow">
            </el-input>
            <span v-else>{{scope.row.gx}}</span>
        </template>
    </el-table-column>
    <el-table-column label="操作" align="center" width="120px">
        <template scope="scope">
            <el-button  type="text"  size="small"
            @click="handleConfirm(scope.$index, scope.row)"
            v-if="scope.row.isShow">确定</el-button>
            <el-button size="small" type="text"
            @click="handleEdit(scope.$index, scope.row)" v-else>编辑</el-button>
            <el-button size="small" type="text"
            @click="handleCancel(scope.$index, scope.row)"
            v-if="scope.row.isShow">取消</el-button>
            <el-button size="small"  type="text"
            @click="handleDelete(scope.$index)" v-else>删除</el-button>
        </template>
    </el-table-column>
</el-table>
<div @click="addNew" class="tjxcy"><span>+添加新成员</span></div>
</div>
</template>

<script>
import { transNumToId } from '@/libs/utils';

export default {
  name: '',
  data() {
    return {
      familyData: [],
      storageArr: [],
      storageData: null,
      addable: true, // 是否可以新增加
      isEdit: false, // 是否是编辑状态 区分新增状态
      IdArray: [
        { value: '1', label: '身份证' },
        { value: '2', label: '港澳台身份证' },
        { value: '3', label: '护照' },
        { value: '4', label: '户口簿' },
        { value: '5', label: '军官证(士兵证)' },
        { value: '6', label: '组织机构代码' },
        { value: '7', label: '营业执照' },
        { value: '8', label: '统一社会信用代码证' },
        { value: '9', label: '其他' },
      ],
    };
  },
  watch: {
    familyData: {
      handler(nval) {
        this.$emit('familyFn', nval);
      },
      deep: true,
    },
  },
  methods: {
    selectChange(index, row) {
      this.familyData[index].zjlbzw = transNumToId(row.zjlb);
    },
    addNew() { // 新增
      if (this.addable) { // 确保只新增一次
        this.storageArr = this.familyData.slice(0);
        this.familyData.push({
          name: '',
          zjlb: '',
          zjlbzw: '',
          zjhm: '',
          gx: '',
          sxh: '',
          isShow: true,
        });
        this.addable = false;
      } else {
        this.$message.error('请填写完成后再添加');
      }
    },
    handleConfirm(index, row) { // 确定
      this.familyData[index].sxh = index + 1;
      const keyrow = Object.keys(row);
      const narr = keyrow.filter(item => row[item] === '');
      if (narr.length > 0) {
        this.$message.error('请填写完整信息');
      } else {
        row.isShow = false;
        this.addable = true; // 新增状态还原
        this.storageData = null; // 编辑暂存清空
        this.isEdit = false; // 编辑状态还原
      }
    },
    handleEdit(index, row) { // 编辑
      this.storageData = Object.assign({}, row);
      this.isEdit = true; // true代表现在是编辑状态
      row.isShow = true;
    },
    handleCancel(index, row) { // 取消
      if (this.isEdit) { // 如果是在编辑状态下 取消 就还原当前行的暂存信息
        this.familyData[index] = this.storageData;
        this.storageData = null; // 成功后清除暂存信息
        this.isEdit = false; // 还原编辑状态
      } else { // 如果是新增加的时候 取消 就还原之前的table数据
        this.familyData = this.storageArr.slice(0);
        this.addable = true; // 取消后把新增状态还原
      }
      row.isShow = false;
    },

    handleDelete(index) { // 删除
      this.familyData.splice(index, 1);
    },
    // 修改table header的背景色
    tableHeaderColor({ rowIndex }) {
      let sty = 'padding:5px 1px;background:#F2F6FC;';
      if (rowIndex === 0 || rowIndex === 1) {
        sty = 'padding:5px 1px;background:#F2F6FC;font-size:14px;color:rgba(102,102,102,1);font-weight:400; height:15px;';
      }
      return sty;
    },
  },
};
</script>

<style lang="scss" scoped>

.tjxcy{
    width: 100%;
    height: 40px;
    border: 1px dashed $--border-color-grey-leftMenu;
    position: relative;
    margin-top: 20px;
    cursor: pointer;
}
.tjxcy span{
    position: absolute;
    font-size: 14px;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
}
</style>
